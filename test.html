<!DOCTYPE html>
<html>
<head>
    <title>WikiQuest</title>
    <link rel="stylesheet" type="text/css" href="css/wikiQuest.css">
    <!--wiki stylesheets -->
    <link rel="stylesheet" href="https://en.wikipedia.org/w/load.php?debug=false&amp;lang=en&amp;modules=ext.gadget.WatchlistBase%2CWatchlistGreenIndicators%7Cext.uls.nojs%7Cext.visualEditor.desktopArticleTarget.noscript%7Cmediawiki.legacy.shared%7Cmediawiki.sectionAnchor%7Cmediawiki.skinning.interface%7Cskins.vector.styles%7Cwikibase.client.init&amp;only=styles&amp;skin=vector" />
    <link rel="stylesheet" href="https://en.wikipedia.org/w/load.php?debug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint&amp;only=styles&amp;skin=vector" media="print" />
    <link rel="stylesheet" href="https://en.wikipedia.org/w/load.php?debug=false&amp;lang=en&amp;modules=site&amp;only=styles&amp;skin=vector" />
    <style>a:lang(ar),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}</style>
    <!--End wiki stylesheets -->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
</head>

<body>
<div id="insertTest"></div>

<script>
var wikipediaHTMLResult = function(data) {
    console.log(data);
    var readData = $('<div>' + data.parse.text['*'] + '</div>');
    // handle redirects
    var redirect = readData.find('.redirectText a').text();
    if(redirect != '') {
        callWikipediaAPI(redirect);
        return;
    }
    //start handling*/
    //patch a tags
    $(readData).find( 'a' ).each(function() {
        var oldRef = $(this).attr('href');
        var newRef=''; 
        if(oldRef) {
            if (oldRef[0]=='#') newRef = oldRef; 
            else if (oldRef[0]=='/' && oldRef[1]=='w' && oldRef[2]!='/') {
                var index = oldRef.lastIndexOf('/');
                var pageName= oldRef.substring(index+1);
                newRef = 'javascript:callWikipediaAPI("'+pageName+'");';
            }
            else newRef='#';
            $(this).attr('href', newRef);
        }
    });
    //patch img
    $(readData).find( 'img' ).each(function() {
        var oldSrc = $(this).attr('src');
        var newSrc = 'https:'+oldSrc;
        $(this).attr('src', newSrc);
        $(this).attr('srcset', '');
    });
    //done patching
    $('#insertTest')[0].innerHTML='';
    $('#insertTest').append(readData);
};
function callWikipediaAPI(wikipediaPage) {
    // http://www.mediawiki.org/wiki/API:Parsing_wikitext#parse
    $.getJSON('http://en.wikipedia.org/w/api.php?action=parse&format=json&callback=?', {page:wikipediaPage, prop:'text|images', uselang:'en'}, wikipediaHTMLResult);
}
callWikipediaAPI('Flat_bread');
</script>
</body>

</html>